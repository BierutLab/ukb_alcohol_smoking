---
title: "Visualize interaction"
---

Plot of the interaction in the left caudate (T2* magnetic susceptibility)

```{r}

library(dplyr) # Run install.packages("tidyverse") to get this
library(tidyr) # Run install.packages("tidyr") to get this
library(ggplot2)
library("reshape") # Run install.packages("reshape") to get this
library("broom")
library(kableExtra) # Run install.packages("kableExtra")
library(forcats)
library(viridis)

```

Set the date prior steps of the pipeline were run
```{r}

run_date <- "2024-07-29"

```

Set the filepaths for input and output
ENSURE THIS IS A LOCATION SUITABLE FOR STORAGE OF UKB DATA
```{r}

input_path <- # data set storage location

output_path <- # script outputs storage location

```


No FDR adjustment applied in the regression model script
```{r}

p_value <- 0.01

```


Load the regression results
```{r}

load(paste0(output_path, "regression_scaled_", run_date, ".RData"))

```


Also load the n-table, this is a reference for the N of each MRI subtype
```{r}

load(paste0(output_path, "regression_n_tracker_", run_date, ".RData"))

```


After this point I am only using the final column of the n_tracker
```{r}

regression_n <- regression_n_tracker %>%
  select(MRI, N)

```



```{r}

total_volume_IDPs <- c("X26514.2.0", "X26518.2.0", "total_wm", "X26527.2.0")

```

```{r}

theme_replace(
  # Set the axis text size
  axis.text.x = element_text(size = 13), axis.text.y = element_text(size = 13),
  # Background white with no grid lines
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "white", color = "dark grey"))

set_dpi = 1200

```


Interaction Manhattan plot

Set display group
```{r}

all_IDP_results <- all_IDP_results %>%
  # Set the display names for color
  mutate(display_group = paste0(MRI, "_", map, "_", dimension, "_", dMRI)) %>%
  mutate(display_group = gsub("_NA", "", display_group)) %>%
  mutate(display_group = gsub("_weighted_mean_", " ", display_group)) %>%
  mutate(display_group = gsub("_", " ", display_group)) %>%
  mutate(display_group = ifelse(IDP %in% total_volume_IDPs, "T1 total volume", display_group)) %>%
  mutate(display_group = factor(display_group, levels = c("T1 total volume",
                                                          "T1 freesurfer DKT area",
                                                          "T1 freesurfer DKT thickness",
                                                          "T1 freesurfer DKT volume",
                                                          "T1 freesurfer ASEG volume",
                                                          "T2",
                                                          "rfMRI",
                                                          "dMRI FA",
                                                          "dMRI MD",
                                                          "dMRI ICVF",
                                                          "dMRI ISOVF"))) %>%
  mutate(display_levels = as.integer(display_group))

```


Make the Manhattan plot (this one has all IDPs, including total volume)
```{r, fig.height=3, fig.width=5}

p_value <- 0.01

#Define two shades to alternate for the different regions
color_a <- "#000000"
color_b = "#bcbcbc"

manhattan_plot <- all_IDP_results %>%
  mutate(color = ifelse(display_levels %% 2, color_b, color_a)) %>%
  ggplot(aes(x = reorder(IDP, display_levels), y = -log10(scaled_interaction_p), color = color)) +
  geom_point() +
  ggtitle(paste0("Manhattan plot of interaction term in all IDPs",
                 "\nN between ", min(regression_n$N), " to ", max(regression_n$N),
                 ", IDPs=", nrow(all_IDP_results),
                 ", Significant = ",
                 nrow(filter(all_IDP_results, scaled_interaction_p <= (p_value))),
                 "\nSignificance threshold: p < ", formatC(p_value, digits = 2, format = "f"))) +
  xlab(" ") +
  ylab("Negative log p value") +
  geom_hline(yintercept = -log10(p_value), linetype = "dashed", color = "dark grey") +
  geom_hline(yintercept = -log10(0.05 / nrow(all_IDP_results)), linetype = "dashed", color = "dark grey") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        legend.position = "none") +
  ylim(c(0, 8)) +
  scale_color_manual(values = c(color_a, color_b))

manhattan_plot


```


```{r}

p_value <- 0.01

sig_interaction_table <- all_IDP_results %>%
  filter(scaled_interaction_p < p_value) %>%
  select(display_group, numeric_IDP, IDP_name, scaled_week_drinks_beta, scaled_week_drinks_p,
         scaled_pack_years_beta, scaled_pack_years_p,
         scaled_interaction_beta, scaled_interaction_p) %>%
  # Do some processing so the names display nicely
  mutate(IDP_name = gsub(" hemisphere", "", IDP_name)) %>%
  mutate(IDP_name = gsub("whole brain", "medial", IDP_name)) %>%
  mutate(IDP_name = gsub("Volume of ", "", IDP_name)) %>%
  mutate(IDP_name = gsub("Median T2star in ", "", IDP_name)) %>%
  mutate(IDP_name = gsub("Weighted-mean MD in tract ", "", IDP_name)) %>%
  mutate(IDP_name = gsub("Weighted-mean ICVF in tract ", "", IDP_name)) %>%
  mutate(IDP_name = gsub("Weighted-mean ISOVF in tract ", "", IDP_name)) %>%
  mutate(IDP_name = trimws(IDP_name)) %>%
  mutate_at(c("scaled_week_drinks_beta", "scaled_pack_years_beta", "scaled_interaction_beta"),
            ~formatC(.x, digits = 3, format = "f")) %>%
  mutate_at(c("scaled_week_drinks_p", "scaled_pack_years_p", "scaled_interaction_p"),
            ~ifelse(.x < 0.01, formatC(.x, digits = 1, format = "e"), formatC(.x, digits = 2, format = "f"))) %>%
  arrange(display_group)

sig_interaction_table

```


T2 in the left caudate has the largest interaction effect size and smallest p value
Beta = 0.019, p = 6.1e-7
```{r}

left_caudate <- all_IDP_results %>%
  filter(numeric_IDP == 25028)

```


Make plots of left caudate by drinks per week, stratified on pack years
```{r}

drink_levels <- c(0, 2, 7, 14, 21)
dpw <- rep(drink_levels, 5)

pack_years <- c(rep(0, length(drink_levels)),
                rep(10, length(drink_levels)),
                rep(20, length(drink_levels)),
                rep(30, length(drink_levels)),
                rep(40, length(drink_levels)))

left_caudate_pred <- data.frame("dpw" = dpw, "pack_years" = pack_years)

```

Convert to z-scores using the pre-scaling values saved from running the pipeline
```{r}

load(paste0(output_path, "pre_scaling_", run_date, ".RData"))

```

```{r}

left_caudate_pred <- left_caudate_pred %>%
  mutate(dpw_z = (dpw - pull(select(filter(pre_scaling, covariate == "week_drinks"), mean))) / 
           pull(select(filter(pre_scaling, covariate == "week_drinks"), sd))) %>%
  
  mutate(pack_years_z = (pack_years - pull(select(filter(pre_scaling, covariate == "pack_years"), mean))) / 
           pull(select(filter(pre_scaling, covariate == "pack_years"), sd)))

```

Add direct effects
```{r}

left_caudate_pred <- left_caudate_pred %>%
  mutate(dpw_direct = dpw_z * left_caudate$scaled_week_drinks_beta) %>%
  mutate(pack_years_direct = pack_years_z * left_caudate$scaled_pack_years_beta)

```


Calculate total decrease for each combination of dpw and pack years incorporating interaction
```{r}

left_caudate_pred <- left_caudate_pred %>%
  mutate(pred = dpw_direct + pack_years_direct +
           left_caudate$scaled_interaction_beta * dpw_z * pack_years_z)

```

Add error bars
Confidence intervals on betas
```{r}

left_caudate <- left_caudate %>%
  mutate(dpw_beta_lower = scaled_week_drinks_beta - 1.96 * left_caudate$scaled_week_drinks_se) %>%
  mutate(dpw_beta_upper = scaled_week_drinks_beta + 1.96 * left_caudate$scaled_week_drinks_se) %>%
  mutate(pack_years_beta_lower = scaled_pack_years_beta - 1.96 * left_caudate$scaled_pack_years_se) %>%
  mutate(pack_years_beta_upper = scaled_pack_years_beta + 1.96 * left_caudate$scaled_pack_years_se) %>%
  mutate(interaction_beta_lower = scaled_interaction_beta - 1.96 * left_caudate$scaled_interaction_se) %>%
  mutate(interaction_beta_upper = scaled_interaction_beta + 1.96 * left_caudate$scaled_interaction_se)

```

Get upper and lower values on pred
```{r}

left_caudate_pred <- left_caudate_pred %>%
  mutate(dpw_direct_lower = dpw_z * left_caudate$dpw_beta_lower) %>%
  mutate(dpw_direct_upper = dpw_z * left_caudate$dpw_beta_upper) %>%
  mutate(pack_years_lower = pack_years_z * left_caudate$pack_years_beta_lower) %>%
  mutate(pack_years_upper = pack_years_z * left_caudate$pack_years_beta_upper) %>%
mutate(pred_lower = dpw_direct_lower + pack_years_lower +
           left_caudate$interaction_beta_lower * dpw_z * pack_years_z) %>%
  mutate(pred_upper = dpw_direct_upper + pack_years_upper +
           left_caudate$interaction_beta_upper * dpw_z * pack_years_z)


```



```{r, fig.height=3, fig.width=4}

pack_years_plot <- left_caudate_pred %>%
  mutate(dpw = factor(dpw)) %>%
  mutate(pack_years = factor(pack_years)) %>%
  ggplot(aes(x = pack_years, y = pred, color = dpw, group = dpw)) +
  geom_point(size = 2) +
  geom_line(size = 0.6) +
  #geom_errorbar(aes(x = pack_years, ymin = pred_lower, ymax = pred_upper), width=0.09)
  geom_ribbon(aes(ymin = pred_lower, ymax = pred_upper, fill = dpw, group = dpw), alpha = 0.2, colour = NA) +
  ggtitle("Predicted decrease in T2* in left caudate") +
  xlab("Pack years") +
  ylab("Magnetic susceptibility from T2*") +
  scale_x_discrete(expand = c(0.01, 0.01)) +
  scale_color_viridis(discrete = TRUE, end = 0.8) +
  scale_fill_viridis(discrete = TRUE, end = 0.8)

ggsave(
  "pack_years_interaction_lc.png",
  pack_years_plot,
  width = 4,
  height = 3,
  dpi = set_dpi)

pack_years_plot

```


```{r, fig.height=3, fig.width=4}

dpw_plot <- left_caudate_pred %>%
  mutate(dpw = factor(dpw)) %>%
  mutate(pack_years = factor(pack_years)) %>%

  ggplot(aes(x = dpw, y = pred, color = pack_years, group = pack_years)) +
  geom_point(size = 2) +
  geom_line(size = 0.6) +
  #geom_errorbar(aes(x = pack_years, ymin = pred_lower, ymax = pred_upper), width=0.09)
  geom_ribbon(aes(ymin = pred_lower, ymax = pred_upper, fill = pack_years, group = pack_years), alpha = 0.2, colour = NA) +
  ggtitle("Predicted decrease in T2* in left caudate") +
  xlab("Drinks per week") +
  ylab("Magnetic susceptibility from T2*") +
  scale_x_discrete(expand = c(0.01, 0.01)) +
  scale_color_viridis(discrete = TRUE, end = 0.8) +
  scale_fill_viridis(discrete = TRUE, end = 0.8)

ggsave(
  "week_drinks_interaction_lc.png",
  dpw_plot,
  width = 4,
  height = 3,
  dpi = set_dpi)

dpw_plot

```






