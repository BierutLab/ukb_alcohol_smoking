---
title: "Supplement excel results"
---

Output the regression results as .xlsx files with multiple tabs and a general info front page

8/28/24 small updates in response to Julie feedback
7/29/24 genetic PC are back in
7/24/23 Added title, authors, the equations, make it easier to find key results


```{r}
library(dplyr) # Run install.packages("tidyverse") to get this
library(tidyr) # Run install.packages("tidyr") to get this
library(ggplot2)
library("reshape") # Run install.packages("reshape") to get this
library("broom")
library(kableExtra) # Run install.packages("kableExtra")
library(openxlsx)

```

Set the date prior steps of the pipeline were run
```{r}

run_date <- "2024-07-29"

```


Set the filepath to get input files
```{r}
# Home computer
input_path <- "C:/Users/tvera/Box/UK Biobank/Data Sets/"

# Work computer
#input_path <- "C:/Users/vthornton/Box/UK Biobank/Data Sets/"

```

Set the filepath to save outputs to
```{r}
# Home computer
output_path <- "C:/Users/tvera/Box/UK Biobank/Alcohol x smoking/"

# Work computer
#output_path <- "C:/Users/vthornton/Box/UK Biobank/Alcohol x smoking/"

```


==============================================================================
Generate excel file with main analysis results

Load the regression results, there should be a file both with and without brain volume included as a covariate

```{r}

# Load the results
load(paste0(output_path, "regression_scaled_", run_date, ".RData"))

```

The IDPs with mis-classified dimension:
X26548.2.0	Mean intensity of Accumbens-area (left hemisphere)			
X26564.2.0	Volume of Accumbens-area (left hemisphere)			
X26579.2.0	Mean intensity of Accumbens-area (right hemisphere)			
X26595.2.0	Volume of Accumbens-area (right hemisphere)

Temp fix for this
```{r}

all_IDP_results <- all_IDP_results %>%
  mutate(dimension = ifelse(IDP %in% c("X26564.2.0", "X26595.2.0"), "volume", dimension))

```


Load the n-table, this is a reference for the N of each MRI subtype
```{r}

load(paste0(output_path, "n_tracker_p7_", run_date, ".RData"))
load(paste0(output_path, "regression_n_tracker_", run_date, ".RData"))

# Join the trackers
n_tracker <- n_tracker %>%
  mutate(MRI = "All") %>%
  relocate(MRI, .before = "N") %>%
  rbind(regression_n_tracker) %>%
  # Drop counts for MRI sequences we don't analyze
  filter(! MRI %in% c("free_2009", "desikan")) %>%
  # Do some renaming so the MRI sequence names correspond to what they are called in the paper
  mutate(MRI = case_when(
    MRI == "GMV" ~ "T1 total volumes",
    MRI == "T1_regional" ~ "T1 Freesurfer DKT and ASEG",
    TRUE ~ MRI))

```


Laura likes to get a table of the regression results as a .csv to look though, export them in this format
Use the openxlsx package to do this
Make a table with info about what is in the sheet
UPDATE THIS IF ADDING CONTROLS

```{r}

general_info <- data.frame((rbind(
  c("Column info", "Explanation of column names", " "),
  c("Unscaled total volumes", "Results in total brain volumes without z-score normalizing IDP or main predictors",
    "total brain IDP (unscaled) ~ drinks per week + pack years + drinks per week*pack years + covariates"),
  c("Scaled total volumes", "Results in total brain volumes WITH z-score normalizing IDP or main predictors",
    "total brain IDP (normalized) ~ scaled drinks per week + scaled pack years + scaled drinks per week*pack years + covariates"),
  c("Correlation", "Correlation between z-scores of alcohol and smoking in sets based on MRI sequence / parcellation",
    " "),
  c("Health direction", "How many IDPs surpassing the 1% significance threshold in each set are in the direction of negative vs. positive brain health",
    " "),
  c("freesurfer DKT", "Results in area, thickness, and volume IDPs from Freesurfer DKT parcellation",
    "regional IDP (scaled) ~ scaled drinks per week + scaled pack years + scaled drinks per week*scaled pack years + covariates"),
  c("freesurfer ASEG", "Results in regional volume IDPs representing tissue and ventricles from Freesurfer ASEG parcellation",
    "regional IDP (scaled) ~ scaled drinks per week + scaled pack years + scaled drinks per week*scaled pack years + covariates"),
  c("T2", "Results in IDPs representing magnetic susceptibility from T2 MRI",
    "T2 IDP (scaled) ~ scaled drinks per week + scaled pack years + scaled drinks per week*scaled pack years + covariates"),
  c("dMRI", "Results in dMRI IDPs",
    "dMRI IDP (scaled) ~ scaled drinks per week + scaled pack years + scaled drinks per week*scaled pack years + covariates"),
  c("rfMRI", "Results in rfMRI IDPs",
    "rfMRI IDP (scaled) ~ scaled drinks per week + scaled pack years + scaled drinks per week*scaled pack years + covariates"),
  c("n_tracker", "Table with n participants by analysis step", " "),
  c("Paper title: ", "Alcohol, tobacco, and brain structure: common or substance specific associations", " "),
  c("Contact: ", "Vera Thornton, vthornton@wustl.edu", " "),
  c("Date", paste0(Sys.Date()), " "))))

colnames(general_info) <- c("Tab", "Description", "Equation")

general_info %>%
  kable() %>%
  kable_classic(full_width = F, html_font = "Cambria")


```

Grab a list of aseg ventricles before removing some columns

```{r}

aseg_ventricles <- all_IDP_results %>%
  filter(region == "ventricles") %>%
  select(IDP, IDP_name)

aseg_ventricles

```


Do some re-organization of columns so the important ones are easy to find
Drop some columns that are more for me: numeric IDP, cortical, display group
```{r}

all_IDP_results <- all_IDP_results %>%
  select(-c(numeric_IDP, cortical, display_group, region)) %>%
  relocate(c(IDP_name, MRI, map, dimension, dMRI, hemisphere, paired), .before = intercept_beta) %>%
  relocate(c(scaled_interaction_beta, scaled_interaction_se, scaled_interaction_p), .before = sex_beta) %>%
  relocate(c(scaled_week_drinks_beta, scaled_week_drinks_se, scaled_week_drinks_p,
             scaled_pack_years_beta, scaled_pack_years_se, scaled_pack_years_p),
           .before = sex_beta) %>%
  relocate(c(scaled_interaction_beta, scaled_interaction_se,
             scaled_interaction_p), .before = sex_beta)

```


Columns in the table:
```{r}

colnames(all_IDP_results)

```

Make a table with an explanation of what the columns are:
```{r}

column_info <- data.frame((rbind(
  # IDP
 c("IDP", "UK Biobank data field for IDP", " "),
 c("IDP_name", "Descriptive name of IDP", " "),
 c("MRI", "MRI sequence (T1, T2, dMRI, rfMRI)", " "),             
 c("map", "Parcellation used to define regional IDPs", " "),
 c("dMRI", "dMRI measure for applicable IDPs (FA, MD, ICVF, ISOVF, MO, OD)", " "),
 c("dimension", "Area, thickness, or volume for structural IDPs", " "),
 c("hemisphere", "Right or left for paired regionak IDPs", " "),
 c("paired", "Oppsite side IDP for bilateral regional IDPs", " "),
 
 c("intercept", "Regression intercept", " "),
 
 # Week drinks and pack years
 c("scaled_week_drinks", "Drinks per week (normalized)", "weekly = 1568 + 1578 + 1588 + 1598 + 1608 + 5364,
   monthly = (4407 + 4418 + 4429 + 4440 + 4451 + 4462) / 4.3"),
 c("scaled_pack_years", "Pack years smoking (normalized)", "20161"),
 c("scaled_interaction", "Interaction term between normalized drinks per week and pack years smoking", " "),
 c("week_drinks", "Drinks per week (not normalized)", "weekly = 1568 + 1578 + 1588 + 1598 + 1608 + 5364,
   monthly = (4407 + 4418 + 4429 + 4440 + 4451 + 4462) / 4.3"),
 c("pack_years", "Pack years smoking (not normalized)", "20161"),
 c("Interaction", "Interaction term between un-normalized drinks per week and pack years smoking", " "),
 
 # Person
 c("sex", "Sex (genetic)", "22001"),
 c("age", "Age at imaging appointment (years)", "21003"),
 
 # Attainment
 c("income", "Income (pounds)", "738"),
 c("education_years", "Years of education derived from Qualifications", "6138"),
 
 # Health
 c("bmi", "Body mass index", "21001"),
 c("diabetes", "Diabetes diagnosed by a doctor", "2443"),
 c("systolic_bp", "Systolic blood pressure (mmHg)", "4080 (automatic), 93 (manual)"),
 c("diastolic_bp", "Diastolic blood pressure (mmHg)", "4079 (automatic), 94 (manual)"),
 
 # Imaging
 c("head_size", "Volumetric scaling from T1 to standard space", "25000"),
 c("site", "Imaging site", "54"),
 c("date", "Imaging date (days since January 1 1970)", "53"),
 c("rfmri_motion", "Mean rfMRI motion", "25741"),
 
 # Genetic
 c("pc_n", "nth genetic principal component", "22009"))))

colnames(column_info) <- c("Column name", "Description", "Derived from data fields")

column_info %>%
  kable() %>%
  kable_classic(full_width = F, html_font = "Cambria")

```

```{r}

main_results <- all_IDP_results
rm(all_IDP_results)

```


Load scaled total volumes, correlation results, and the health direction counts
```{r}


load(paste0(output_path, "regression_UNscaled_", run_date, ".RData"))
load(paste0("correlation_results_", "2024-08-14", ".RData"))
load(paste0("health_direction_", "2024-09-24", ".RData"))

unscaled_results <- all_IDP_results
rm(all_IDP_results)

```

Pull out just the total volumes and do some re-arranging

```{r}


total_volume_IDPs <- c("X26514.2.0", "X26518.2.0", "total_wm", "X26527.2.0")

unscaled_total_volume <- unscaled_results %>%
  filter(IDP %in% total_volume_IDPs) %>%
  select(-c(numeric_IDP, cortical, display_group, region)) %>%
  relocate(c(IDP_name, MRI, map, dimension, dMRI, hemisphere, paired), .before = intercept_beta) %>%
  relocate(c(interaction_beta, interaction_se, interaction_p), .before = sex_beta) %>%
  relocate(c(week_drinks_beta, week_drinks_se, week_drinks_p,
             pack_years_beta, pack_years_se, pack_years_p),
           .before = sex_beta) %>%
  relocate(c(interaction_beta, interaction_se,
             interaction_p), .before = sex_beta) %>%
  select(where(~!all(is.na(.x))))

rm(unscaled_results)

```

Make a corresponding table with the scaled total volumes
```{r}

scaled_total_volume <- main_results %>%
  filter(IDP %in% total_volume_IDPs) %>%
  select(where(~!all(is.na(.x))))

```


Some re-arranging in correlation results to make it more clear what we mean by "in common"
```{r}

corr_results_table <- corr_results_table %>%
  relocate(common, .after = p_threshold) %>%
  dplyr::rename("common association defined on threshold" = common)

```

Add a column to aseg subcortical indicating what is ventricle vs. tissue volumes

select(filter(main_results, map == "freesurfer_ASEG"), where(~!all(is.na(.x))))
```{r}

aseg_results <- main_results %>%
  filter(map == "freesurfer_ASEG") %>%
  select(where(~!all(is.na(.x)))) %>%
  filter(! IDP %in% total_volume_IDPs) %>%
  mutate(volume_type = ifelse(IDP %in% aseg_ventricles$IDP, "ventricle", "tissue")) %>%
  relocate(volume_type, .after = dimension)



```

Save the xlsx sheet with multiple tabs, including general info to tell people what this is

```{r}

results <- list("general_info" = general_info,
                        "column_info" = column_info,
                        "unscaled_total_volumes" = unscaled_total_volume,
                        "scaled_total_volumes" = scaled_total_volume,
                        "correlation" = corr_results_table,
                        "health direction" = health_direction,
                        "DKT_cortical" = select(filter(main_results, map == "freesurfer_DKT"), where(~!all(is.na(.x)))),
                        "ASEG_subcortical" = aseg_results,
                        "T2" = select(filter(main_results, MRI == "T2"), where(~!all(is.na(.x)))),
                        "rfMRI" = select(filter(main_results, MRI == "rfMRI"), where(~!all(is.na(.x)))),
                        "dMRI" = select(filter(main_results, MRI == "dMRI"), where(~!all(is.na(.x)))),
                        "n_tracker" = n_tracker)

write.xlsx(results, file = paste0("alcohol_smoking_full_results_", Sys.Date(), ".xlsx"))

```


Some cleanup after generating:
- Go check that column widths make sense
- I like to add a comment about what is meant by "in common" in the last column of the correlation results

